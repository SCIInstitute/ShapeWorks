<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Shireen Elhabian et al.">
  <link rel="canonical" href="http://www.sci.utah.edu/software/shapeworks.html/use-cases/deep-ssm-femur.html">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Femur SSM Directly from Images - ShapeWorks</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../css/custom.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Femur SSM Directly from Images";
    var mkdocs_page_input_path = "use-cases/deep-ssm-femur.md";
    var mkdocs_page_url = "/software/shapeworks.html/use-cases/deep-ssm-femur.html";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-36723568-3', 'mkdocs.org');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> ShapeWorks</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Getting Started</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../getting-started/shapes.html">Shapes, What & From Where?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../getting-started/workflow.html">Shape Modeling Workflow</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../getting-started/sw-stories.html">ShapeWorks Success Stories</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../getting-started/interfaces.html">ShapeWorks Interfaces</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../getting-started/examples.html">Examples</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../getting-started/how-tos.html">How-Tos</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">For Users</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../users/install.html">How to Install ShapeWorks?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../users/citation.html">How to Cite ShapeWorks?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../users/papers.html">Revelant Papers</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Workflow</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../workflow/groom.html">How to Groom Your Dataset?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../workflow/optimize.html">How to Optimize Your Shape Model?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../workflow/analyze.html">How to Analyze Your Shape Model?</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">What is New?</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../new/new-studio.html">New in ShapeWorksStudio</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../new/openvdb.html">ShapeWorks Takes ~85% Less Memory</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../new/sw-meshes.html">ShapeWorks Directly on Meshes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../new/shapeworks-command.html">ShapeWorks Command</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../new/ssm-eval.html">Shape Model Evaluation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../new/shapeworks-python.html">ShapeWorks in Python</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">ShapeWorks Studio</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../studio/getting-started-with-studio.html">Getting Started With ShapeWorks Studio</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">ShapeWorks in Python</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/getting-started-with-jupyter-notebooks.html">Getting Started with Juypter Notebooks</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/setting-up-shapeworks-environment.html">Setting up ShapeWorks Environment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/getting-started-with-segmentations.html">Getting Started with Segmentations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/getting-started-with-meshes.html">Getting Started with Meshes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/getting-started-with-exploring-segmentations.html">Getting Started with Exploring Segmentations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/getting-started-with-grooming-segmentations.html">Getting Started with Grooming Segmentations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/getting-started-with-data-augmentation.html">Getting Started with Data Augmentation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/getting-started-with-shape-cohort-generation.html">Getting Started with Shape Cohort Generation</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Deep Learning & SSMs</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../deep-learning/data-augmentation.html">Data Augmentation for Deep Learning</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../deep-learning/deep-ssm.html">SSMs Directly from Images</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Use Cases</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="use-cases.html">Getting Started with Use Cases</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="ellipsoid.html">Ellipsoid: Basic Example</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="ellipsoid-cutting-planes.html">Ellipsoid: Cutting Planes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="fixed-domain-ellipsoid.html">Fixed Domains: SSM on New Shapes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="left-atrium.html">Left Atrium: SSM from Segmentations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="femur.html">Femur: SSM from Meshes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="femur-cutting-planes.html">Femur with Cutting Planes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="femur-mesh.html">Femur Mesh: SSM directly from meshes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="lumps.html">Lumps: SSM directly from meshes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="right-ventricle.html">Right Ventricle: Highly Variable Shapes</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="deep-ssm-femur.html">Femur SSM Directly from Images</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#what-and-where-is-the-use-case">What and Where is the Use Case?</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#running-the-use-case">Running the Use Case</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#use-case-pipeline">Use Case Pipeline</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#step-1-getting-the-original-data">Step 1: Getting the original data</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-2-running-data-augmentation">Step 2: Running data augmentation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-3-creating-torch-loaders">Step 3: Creating torch loaders</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-4-training-deepssm">Step 4: Training DeepSSM</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-5-testing-deepssm">Step 5: Testing DeepSSM</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-6-analyze-deepssm-results">Step 6: Analyze DeepSSM Results</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">For Developers</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/build.html">How to Build ShapeWorks from Source?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/contribute.html">How to Contribute to ShapeWorks?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/commands.html">How to Add ShapeWorks Commands?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/python-apis.html">How to Add Python APIs?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/tests.html">How to Add and Run Unit Tests?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/new-use-case.html">How to Add New Use Cases?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/datasets.html">How to Add New Datasets?</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/modify-datasets.html">When Modifying Existing Datasets</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/docs.html">Getting Started with Documentation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/gh-actions.html">Getting Started with GitHub Actions</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/markdown.html">Getting Started with Markdown</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/paths.html">Adding to PATH Environment Variable</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">ShapeWorks Tools</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../tools/ShapeWorksCommands.html">ShapeWorks Commands</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">About</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../about/team.html">Meet ShapeWorkers!</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../about/release-notes.html">Release Notes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../about/license.html">License</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../about/contact.html">Contact Us</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">ShapeWorks</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Use Cases &raquo;</li>
        
      
    
    <li>Femur SSM Directly from Images</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/SCIInstitute/ShapeWorks/edit/master/docs/use-cases/deep-ssm-femur.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="femur-ssm-directly-from-images">Femur SSM Directly from Images</h1>
<h2 id="what-and-where-is-the-use-case">What and Where is the Use Case?</h2>
<p>This use case demonstrates how to get shape models from unsegmented images using deep learning on the femur data. This includes performing data augmentation as well as building, training and testing a DeepSSM model. For a detailed description of these processes, please see <a href="../deep-learning/data-augmentation.html">Data Augmentation for Deep Learning</a> and <a href="../deep-learning/deep-ssm.html">SSMs Directly from Images</a>. The image and shape data used for training and testing results from running the <a href="femur.html">Femur: SSM from Meshes</a> use case.</p>
<p>The use case is located at: <code>Examples/Python/deep-ssm.py</code></p>
<div class="admonition note">
<p class="admonition-title">Relevant papers</p>
<ul>
<li>Jadie Adams, Riddhish Bhalodia, Shireen Elhabian. Uncertain-DeepSSM: From Images to Probabilistic Shape Models. In MICCAI-ShapeMI, Springer, Cham, 2020.</li>
<li>Riddhish Bhalodia, Shireen Elhabian, Ladislav Kavan, and Ross Whitaker. DeepSSM: a deep learning framework for statistical shape modeling from raw images. In MICCAI-ShapeMI, pp. 244-257. Springer, Cham, 2018.</li>
<li>Riddhish Bhalodia, Anupama Goparaju, Tim Sodergren, Alan Morris, Evgueni Kholmovski, Nassir Marrouche, Joshua Cates, Ross Whitaker, Shireen Elhabian. Deep Learning for End-to-End Atrial Fibrillation Recurrence Estimation. Computing in Cardiology (CinC), 2018.</li>
</ul>
</div>
<h2 id="running-the-use-case">Running the Use Case</h2>
<p>To run the use case, run <code>RunUseCase.py</code> (in <code>Examples/Python/</code>) with proper tags.</p>
<div class="highlight"><pre><span></span><code>$ cd /path/to/shapeworks/Examples/Python
$ python RunUseCase.py --use_case deep_ssm
</code></pre></div>
<p>See <a href="use-cases.html#running-use-case">Getting Started with Use Cases</a> for the full list of tags. Note the following tags are not applicable to this use case:</p>
<ul>
<li><code>--skip_grooming</code></li>
<li><code>--use_single_scale</code></li>
<li><code>--interactive</code></li>
<li><code>--groom_images</code></li>
</ul>
<p>This calls <code>deep_ssm.py</code> (in <code>Examples/Python/</code>) to perform the following.</p>
<ul>
<li>Loads the femur dataset using a local version if it exists (i.e., previously downloaded); otherwise the dataset is automatically downloaded from the <a href="http://cibc1.sci.utah.edu:8080/">ShapeWorks Data Portal</a>. This includes the particle files in <code>shape_models</code> created from running the femur use case. </li>
<li>Performs data augmentation as described in <a href="../deep-learning/data-augmentation.html">Data Augmentation for Deep Learning</a>.</li>
<li>Creates a DeepSSM model as described in <a href="../deep-learning/deep-ssm.html">SSMs Directly from Images</a> and uses it to make predictions on unseen images.</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">On CUDA</p>
<p>This use case uses Pytorch and requires a GPU to run in a timely manner. When you run <code>conda_installs.sh</code>, it detects if you have a GPU and and installs the version of Pytorch compatible with your version of CUDA. </p>
<p>Note we only support the three most recent versions of CUDA. If your GPU requires an older CUDA version, you will need to update the Pytorch install in your shapeworks conda environment to the correct CUDA version. For more information on doing so, see <a href="https://pytorch.org/">pytorch.org</a>. </p>
<p>To do a quick check to see if Pytorch is running on your GPU, you can run the use case with the <code>--tiny-test</code> tag. This will quickly run the use case on a few examples and print an error if it is not running on the GPU.</p>
</div>
<h2 id="use-case-pipeline">Use Case Pipeline</h2>
<h3 id="step-1-getting-the-original-data">Step 1: Getting the original data</h3>
<p>The femur data is downloaded from the <a href="http://cibc1.sci.utah.edu:8080/">ShapeWorks Data Portal</a>. This use case uses the original unsegmented images and the corresponding <code>.particles</code> files in the <code>shape_models</code> folder downloaded with the femur dataset. Of the 50 examples in the femur dataset, 40 are used to create training and validation sets, while the remaining 10 are saved for a test set (i.e., held out data).</p>
<h3 id="step-2-running-data-augmentation">Step 2: Running data augmentation</h3>
<p>For a full description of the data augmentation process and how to use the ShapeWorks data augmentation Python package, please see <a href="../deep-learning/data-augmentation.html">Data Augmentation for Deep Learning</a>. The functions relevant to this step are <code>runDataAugmentation</code> and <code>visualizeAugmentation</code>.</p>
<p>Data augmentation is run using the images and particle files allocated for training and validation. 4960 augmented samples are created so that DeepSSM can be trained on 5000 total examples. The data is embedded to 6 dimensions using PCA, preserving 95% of the population variation. A kernel density estimate (KDE) distribution is then fit to the embedded data and used in sampling new shape samples for data augmentation. The real and augmented results are then visualized in a matrix of scatterplots.</p>
<h3 id="step-3-creating-torch-loaders">Step 3: Creating torch loaders</h3>
<p>For a full description of the DeepSSM process and how to use the ShapeWorks DeepSSM Python package, please see <a href="../deep-learning/deep-ssm.html">SSMs Directly from Images</a>. The functions relevant to this step are <code>getTrainValLoaders</code> and <code>getTestLoader</code>.</p>
<p>The images and particle files are reformatted into tensors for training and testing the DeepSSM network. The 5000 original and augmented image/particle pairs are turned into train (80%) and validation (20%) loaders and the images held out for the test set are turned into a test loader. A batch size of 8 is used for optimal GPU capacity. The images in the train, validation, and test sets are downsampled to 75% of their original size to decrease training time.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a CUDA memory error occurs when running the use case, the batch size value may need to be decreased. </p>
</div>
<h3 id="step-4-training-deepssm">Step 4: Training DeepSSM</h3>
<p>This step uses function <code>trainDeepSSM</code> documented in <a href="../deep-learning/deep-ssm.html">SSMs Directly from Images</a>. A DeepSSM model is created and trained for 50 epochs. A learning rate of 0.0001 is used, and the validation error is calculated and reported every epoch.</p>
<h3 id="step-5-testing-deepssm">Step 5: Testing DeepSSM</h3>
<p>This step uses function <code>testDeepSSM</code> documented in <a href="../deep-learning/deep-ssm.html">SSMs Directly from Images</a>. The trained DeepSSM model is used to predict the PCA scores of the unseen images in the test loader. These scores are then mapped to the particle shape model using the PCA information from data augmentation, and the predicted particles are saved.</p>
<h3 id="step-6-analyze-deepssm-results">Step 6: Analyze DeepSSM Results</h3>
<p>This step uses function <code>analyzeResults</code> documented in <a href="../deep-learning/deep-ssm.html">SSMs Directly from Images</a>. The DeepSSM predictions are analyzed by considering the surface-to-surface distance between the mesh generated from the original segmentation and the mesh generated from the predicted particles. Heat maps of these distances on the meshes are saved from visualizing the results.</p>
<p><img alt="DeepSSM Results" src="../img/deep-learning/DeepSSMResults.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../dev/build.html" class="btn btn-neutral float-right" title="How to Build ShapeWorks from Source?">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="right-ventricle.html" class="btn btn-neutral" title="Right Ventricle: Highly Variable Shapes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright Â© 1998 - 2020 Scientific Computing and Imaging Institute. All rights reserved. This project is supported by the National Institutes of Health under grant numbers NIBIB-U24EB029011, NIAMS-R01AR076120, NHLBI-R01HL135568, NIBIB-R01EB016701, and NIGMS-P41GM103545. Software maintenance and support are provided within the funding period.</p>
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/SCIInstitute/ShapeWorks/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="right-ventricle.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../dev/build.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../assets/mathjaxhelper.js" defer></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
